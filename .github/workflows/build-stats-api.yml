name: Build and push stats-api

run-name: "${{ github.ref_name }} - ${{ inputs.custom_sha || github.sha }}"

on:
  push:
    paths:
      - "stats-api/**"
  pull_request:
    paths:
      - "stats-api/**"
  workflow_dispatch:
    inputs:
      custom_sha:
        description: 'Custom SHA (image rebuilds only)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  DOCKERFILE: "Dockerfile.api"
  IMAGE_NAME: "stats-api"
  PORT: "8080"
  TARGET: "runtime"
  DEPLOY_WORKFLOW: "deploy-stats-api.yml"

jobs:
  format-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up terraform
        uses: hashicorp/setup-terraform@v3

      - name: Check version
        run: terraform --version

      - name: Format check
        run: terraform fmt -check

  build-push:
    needs: format-check
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.custom_sha || github.sha }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.PROVIDER_NAME }}
          service_account: ${{ vars.SERVICE_ACCOUNT }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker
        run: gcloud auth configure-docker

      - name: Build image, caching from latest
        run: |
          docker pull gcr.io/${{ vars.GCP_PROJECT_ID }}/${IMAGE_NAME}:latest

          docker build --target ${TARGET} --build-arg PORT=${PORT} -f ${DOCKERFILE} \
          --cache-from gcr.io/${{ vars.GCP_PROJECT_ID }}/${IMAGE_NAME}:latest \
          -t gcr.io/${{ vars.GCP_PROJECT_ID }}/${IMAGE_NAME}:${{ inputs.custom_sha || github.sha }} \
          ${{ github.ref_name == 'main' && format('-t gcr.io/{0}/{1}:latest', vars.GCP_PROJECT_ID, env.IMAGE_NAME) || '' }} .

      - name: Push image
        run: docker push --all-tags gcr.io/${{ vars.GCP_PROJECT_ID }}/${IMAGE_NAME}

      - name: Deployment Routing
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: check_env
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            # For main branch, deploy to multiple environments
            echo "envs=development" >> $GITHUB_OUTPUT
            echo "image_tag=latest" >> $GITHUB_OUTPUT
            echo "Deploying to multiple environments with latest tag"
          else

            # Check deployment logic based on event type and PR status
            if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.base_ref }}" = "main" ]; then
              # This is a PR to main - deploy it
              echo "This is a PR to main - proceeding with deployment"
            elif [ "${{ github.event_name }}" = "pull_request" ]; then
              # This is a PR to another branch - check if there's a PR to main
              pr_to_main_exists=$(gh pr list --head "${{ github.head_ref }}" --base main --state open --json number --jq length)
              if [ "$pr_to_main_exists" -gt 0 ]; then
                echo "PR to main exists, skipping this deployment in preference of the 'PR to main'"
                exit 0
              fi
              echo "No PR to main exists, proceeding with deployment"
            else
              # This is a branch build - check if there are ANY PRs involving this branch
              prs_as_head=$(gh pr list --head "${{ github.ref_name }}" --state open --json number --jq length)
              prs_as_base=$(gh pr list --base "${{ github.ref_name }}" --state open --json number --jq length)
              total_prs=$((prs_as_head + prs_as_base))
              if [ "$total_prs" -gt 0 ]; then
                echo "Found $total_prs PR(s) involving branch '${{ github.ref_name }}' - skipping deployment"
                exit 0
              fi
              echo "No PR to main exists, proceeding with deployment"
            fi

            eph_env="${GITHUB_REPOSITORY//\//-}-$([ "${{ github.event_name }}" = "pull_request" ] && echo "$GITHUB_HEAD_REF" || echo "$GITHUB_REF_NAME")"
            echo "Checking for GCP project: $eph_env"
            
            # Check if GCP project exists
            if gcloud projects describe "$eph_env" --quiet 2>/dev/null; then
              echo "envs=$eph_env" >> $GITHUB_OUTPUT
              echo "image_tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
              echo "Ephemeral environment found: $eph_env"
            else
              echo "envs=" >> $GITHUB_OUTPUT
              echo "image_tag=" >> $GITHUB_OUTPUT
              echo "No ephemeral environment found for: $eph_env"
              exit 0
            fi
          fi

      - name: Trigger Deployment
        if: steps.check_env.outputs.envs != ''
        run: |
          IFS=',' read -ra ENVS <<< "${{ steps.check_env.outputs.envs }}"
          for env in "${ENVS[@]}"; do
            echo "Triggering deployment to: $env"
            gh workflow run ${{ inputs.deploy_workflow }} \
              --ref ${{ github.ref }} \
              -f env="$env" \
              -f image_tag="${{ steps.check_env.outputs.image_tag }}"
          done