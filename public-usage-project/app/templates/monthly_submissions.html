<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Monthly Submission</title>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.5.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-gl-3.5.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.5.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.5.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-3.5.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-api-3.5.1.min.js"></script>
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #center-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            flex-direction: column;
        }

        #toggle-button,
        #gridlines-button {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div id="center-container">
        <button id="toggle-button">Switch to Line Graph</button>
        <button id="gridlines-button">Toggle Gridlines</button>
        <div id="myplot-submissions"></div>
    </div>
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function () {
            fetch(window.location.origin + "/api/get_monthly_submissions")
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {

                    // format ISO to month and years for readable data.
                    function formatISOToMonthYear(isoString) {
                        const date = new Date(isoString);
                        const options = { year: 'numeric', month: 'long' };
                        return date.toLocaleDateString('en-US', options);
                    }

                    // create column data source to be used for the graph and hovertool.
                    const source = new Bokeh.ColumnDataSource({
                        data: {
                            month: data.month.map(date => new Date(date)).map(ms => ms.getTime()),
                            formatted_month: data.month.map(formatISOToMonthYear),
                            submissions: data.submissions,
                        }
                    });

                    // create basic plot
                    const p = new Bokeh.Plotting.figure({
                        width: 1000,
                        height: 500,
                        title: "Monthly Submissions",
                        x_axis_label: 'Month',
                        x_axis_type: 'datetime',
                        y_axis_label: 'Submissions',
                        tools: "pan,wheel_zoom,box_zoom,reset,save,tap"
                    });

                    // by default, have our graph display as a vertical bar graph
                    let currentGraphType = 'vbar';

                    // Bokeh will automatically color in the vertical bars based on # of submissions.
                    const colorMapper = new Bokeh.LinearColorMapper({
                        palette: ['#FFD700', '#FFC300', '#FFB700', '#FFAD00', '#FFA000', '#FF9900', '#FF8C00', '#FF8400', '#FF7900']
                    });

                    // function to handle what is currently on the graph on the page. 
                    function updateGraph() {
                        p.renderers = []; // Clear existing renderers
                        // vertical bar and its args
                        if (currentGraphType === 'vbar') {
                            p.vbar({
                                x: { field: 'month' },
                                top: { field: 'submissions' },
                                width: 30.44 * 24 * 60 * 60 * 1000 * 0.85,
                                source: source,
                                fill_color: { field: 'submissions', transform: colorMapper },
                                line_color: 'none'
                            });
                            // change toggle button to the other graph
                            document.getElementById("toggle-button").innerText = "Switch to Line Graph";
                        } else {
                            // line graph and its args
                            p.line(
                                { field: 'month' },
                                { field: 'submissions' },
                                {
                                    source: source,
                                    line_width: 2,
                                    color: '#FF9900'
                                }
                            );
                            // change toggle button to the other graph
                            document.getElementById("toggle-button").innerText = "Switch to Bar Graph";
                        }
                        // display bokeh graph in myplot-submissions div
                        Bokeh.Plotting.show(p, document.getElementById('myplot-submissions'));
                    }

                    // Initial graph
                    updateGraph();

                    // logic for toggle button 
                    document.getElementById('toggle-button').addEventListener('click', function () {
                        currentGraphType = (currentGraphType === 'vbar') ? 'line' : 'vbar';
                        updateGraph();
                    });

                    // Add hover tool
                    const hover = new Bokeh.HoverTool({
                        tooltips: [
                            ["Month", "@formatted_month"],
                            ["Submissions", "@submissions"]
                        ]
                    });
                    p.add_tools(hover);

                    // Toggle gridlines
                    let gridlinesVisible = true;
                    document.getElementById('gridlines-button').addEventListener('click', function () {
                        gridlinesVisible = !gridlinesVisible;
                        p.xgrid.visible = gridlinesVisible;
                        p.ygrid.visible = gridlinesVisible;
                        updateGraph();
                    });

                    // Disable scientific notation on y-axis
                    p.yaxis.formatter = new Bokeh.BasicTickFormatter();

                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        });
    </script>
</body>

</html>
